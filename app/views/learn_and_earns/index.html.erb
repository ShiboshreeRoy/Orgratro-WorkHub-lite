<body class="bg-black text-blue-300 min-h-screen px-4 py-8">
  <h1 class="text-3xl font-bold text-blue-400 mb-6 text-center">Add Learn & Earn Links</h1>

  <% if current_user.admin? %>
    <div class="text-center mb-6 flex flex-col sm:flex-row justify-center gap-4 items-center">
      <div class="text-blue-300 text-sm">
        Showing <%= @learn_and_earns.total_count %> pending/rejected entries
      </div>
      <%= link_to "New Learn & Earn", new_learn_and_earn_path,
          class: "inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-5 rounded transition" %>
      <%= button_to "üöÄ Send to All Users", bulk_create_learn_and_earns_path, 
          method: :post,
          params: { confirm: "Are you sure you want to send this to ALL users?" },
          class: "inline-block bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-5 rounded transition",
          form: { onsubmit: "return confirm('Are you sure you want to send this to ALL users?')" } %>
    </div>
    
    <!-- Hidden Bulk Delete Form -->
    <%= form_with url: bulk_delete_learn_and_earns_path, 
                  method: :delete, 
                  id: "bulk-delete-form", 
                  local: true,
                  style: "display: none;" do |form| %>
      <div id="selected-ids-container"></div>
    <% end %>

    <!-- Bulk Operations Bar -->
    <div id="bulk-actions-bar" class="hidden bg-gray-900/80 backdrop-blur-sm border border-red-500/30 rounded-xl p-4 mb-6 transition-all duration-300">
      <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <i class="fas fa-trash-alt text-red-400"></i>
          <span class="text-red-300 font-semibold" id="selected-count">0</span>
          <span class="text-gray-400">entries selected</span>
        </div>
        <div class="flex gap-3">
          <button type="button" id="select-all" class="text-sm bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
            Select All
          </button>
          <button type="button" id="deselect-all" class="text-sm bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition">
            Deselect All
          </button>
          <button type="button" 
                  id="bulk-delete-button"
                  class="text-sm bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled>
            üóëÔ∏è Delete Selected
          </button>
        </div>
      </div>
    </div>
  <% else %>
    <div class="text-center mb-6 flex flex-col sm:flex-row justify-center gap-4 items-center">
      <div class="text-blue-300 text-sm">
        Showing <%= @learn_and_earns.total_count %> of your entries
      </div>
      <!-- User Features -->
      <div class="flex flex-wrap justify-center gap-2">
        <%= link_to "üìã View All Tasks", tasks_path, 
            class: "inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded transition text-sm" %>
        <%= link_to "üîó Click & Earn", links_path, 
            class: "inline-block bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded transition text-sm" %>
        <%= link_to "üìä My Progress", user_dashbord_index_path, 
            class: "inline-block bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded transition text-sm" %>
      </div>
    </div>
    
    <!-- User Guide Section -->
    <div class="bg-gray-900/50 rounded-xl p-4 mb-6 border border-blue-700/30">
      <h3 class="text-lg font-semibold text-blue-300 mb-3 flex items-center gap-2">
        <i class="fas fa-lightbulb"></i> How to Earn More
      </h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-blue-200">
        <div class="bg-gray-800/30 p-3 rounded-lg">
          <div class="font-semibold text-blue-300 mb-1">1. Complete Tasks</div>
          <p>Visit the Tasks section to find available earning opportunities</p>
        </div>
        <div class="bg-gray-800/30 p-3 rounded-lg">
          <div class="font-semibold text-blue-300 mb-1">2. Click & Earn</div>
          <p>Earn by clicking on promotional links in the Click & Earn section</p>
        </div>
        <div class="bg-gray-800/30 p-3 rounded-lg">
          <div class="font-semibold text-blue-300 mb-1">3. Submit Proofs</div>
          <p>Complete Learn & Earn tasks and submit proof for approval</p>
        </div>
      </div>
    </div>
    
    <!-- Quick Access to Other Earning Methods -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      <!-- Available Tasks -->
      <div class="bg-gray-900/50 rounded-xl p-5 border border-blue-700/30">
        <h3 class="text-lg font-semibold text-blue-300 mb-3 flex items-center gap-2">
          <i class="fas fa-tasks"></i> Available Tasks
        </h3>
        <% if @available_tasks&.any? %>
          <div class="space-y-2 mb-4">
            <% @available_tasks.first(3).each do |task| %>
              <div class="bg-gray-800/30 p-3 rounded-lg">
                <div class="font-medium text-blue-200"><%= task.name %></div>
                <div class="text-sm text-gray-400 mt-1">Reward: $<%= task.reward_amount %></div>
              </div>
            <% end %>
          </div>
          <%= link_to "View All Tasks (#{@available_tasks.count})", tasks_path, 
              class: "inline-block w-full text-center bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded transition" %>
        <% else %>
          <p class="text-gray-400 text-center py-4">No tasks available at the moment</p>
        <% end %>
      </div>
      
      <!-- Available Links -->
      <div class="bg-gray-900/50 rounded-xl p-5 border border-green-700/30">
        <h3 class="text-lg font-semibold text-green-300 mb-3 flex items-center gap-2">
          <i class="fas fa-mouse-pointer"></i> Click & Earn Links
        </h3>
        <% if @available_links&.any? %>
          <div class="space-y-2 mb-4">
            <% @available_links.first(3).each do |link| %>
              <div class="bg-gray-800/30 p-3 rounded-lg">
                <div class="font-medium text-green-200 truncate"><%= link.title %></div>
                <div class="text-sm text-gray-400 mt-1">Earn: $<%= number_with_precision(link.earnings, precision: 4) %> per click</div>
              </div>
            <% end %>
          </div>
          <%= link_to "View All Links (#{@available_links.count})", links_path, 
              class: "inline-block w-full text-center bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded transition" %>
        <% else %>
          <p class="text-gray-400 text-center py-4">No links available at the moment</p>
        <% end %>
      </div>
    </div>
    
    <!-- User Stats (for regular users) -->
    <% unless current_user.admin? %>
      <div class="bg-gradient-to-r from-purple-900/30 to-blue-900/30 rounded-xl p-5 mb-8 border border-purple-700/30">
        <h3 class="text-lg font-semibold text-purple-300 mb-4 text-center">Your Earnings Overview</h3>
        <div class="grid grid-cols-3 gap-4 text-center">
          <div class="bg-gray-800/30 p-4 rounded-lg">
            <div class="text-2xl font-bold text-green-400">$<%= number_with_precision(@user_stats[:total_earned], precision: 2) %></div>
            <div class="text-sm text-gray-400 mt-1">Total Earned</div>
          </div>
          <div class="bg-gray-800/30 p-4 rounded-lg">
            <div class="text-2xl font-bold text-blue-400"><%= @user_stats[:tasks_completed] %></div>
            <div class="text-sm text-gray-400 mt-1">Tasks Completed</div>
          </div>
          <div class="bg-gray-800/30 p-4 rounded-lg">
            <div class="text-2xl font-bold text-yellow-400"><%= @user_stats[:clicks_made] %></div>
            <div class="text-sm text-gray-400 mt-1">Clicks Made</div>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>

  <div class="overflow-x-auto border border-gray-700 rounded-lg shadow-lg">
    <table class="min-w-full divide-y divide-gray-700 text-sm md:text-base">
      <thead class="bg-gray-900">
        <tr>
          <% if current_user.admin? %>
            <th class="px-4 py-3 text-center text-blue-300 uppercase tracking-wide whitespace-nowrap w-12">
              <input type="checkbox" id="select-all-header" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
            </th>
          <% end %>
          <th class="px-4 py-3 text-left text-blue-300 uppercase tracking-wide whitespace-nowrap">Referral Link</th>
          <th class="px-4 py-3 text-left text-blue-300 uppercase tracking-wide whitespace-nowrap">Social Post</th>
          <th class="px-4 py-3 text-left text-blue-300 uppercase tracking-wide whitespace-nowrap">Proof</th>
          <th class="px-4 py-3 text-left text-blue-300 uppercase tracking-wide whitespace-nowrap">Status</th>
          <th class="px-4 py-3 text-center text-blue-300 uppercase tracking-wide whitespace-nowrap">Actions</th>
        </tr>
      </thead>

      <tbody class="bg-black divide-y divide-gray-800 text-blue-100">
        <% @learn_and_earns.each do |entry| %>
          <% next if entry.nil? %>
          <tr class="hover:bg-gray-900 transition-all duration-200" data-entry-id="<%= entry.id %>">
            <% status_colors = { "approved" => "text-green-400", "pending" => "text-yellow-400", "rejected" => "text-red-400" } %>
        
            <% if current_user.admin? %>
              <td class="px-4 py-3 text-center">
                <input type="checkbox" 
                       name="ids[]" 
                       value="<%= entry.id %>" 
                       class="entry-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500 cursor-pointer">
              </td>
            <% end %>
        
            <!-- Referral Link -->
            <td class="px-4 py-3 max-w-xs break-words">
              <div class="flex items-center justify-between gap-2">
                <% if current_user.admin? %>
                  <span class="flex-grow truncate"><%= entry.link %></span>
                <% else %>
                  <span class="flex-grow opacity-70 cursor-not-allowed select-none truncate"><%= entry.link %></span>
                <% end %>

                <button
                  type="button"
                  class="shrink-0 px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-semibold focus:outline-none focus:ring-2 focus:ring-blue-400 transition copy-btn"
                  data-copy-target="<%= dom_id(entry, :link) %>">
                  Copy
                </button>
              </div>
              <span id="<%= dom_id(entry, :link) %>" class="hidden"><%= entry.link %></span>
            </td>

            <!-- Social Post -->
            <td class="px-4 py-3 max-w-xs break-words">
              <% if current_user.admin? %>
                <%= truncate(entry.social_post, length: 60) %>
              <% else %>
                <span class="opacity-70 cursor-not-allowed select-none"><%= truncate(entry.social_post, length: 60) %></span>
              <% end %>
            </td>

            <!-- Proof -->
            <td class="px-4 py-3 max-w-xs break-words"><%= entry.proof %></td>

            <!-- Status -->
            <td class="px-4 py-3 font-semibold">
              <span class="<%= status_colors[entry.status] || 'text-gray-400' %>">
                <%= entry.status.titleize %>
              </span>
            </td>

            <!-- Actions -->
            <td class="px-4 py-3 text-center space-x-4 whitespace-nowrap">
              <% if current_user.admin? %>
                <%= link_to "Show", learn_and_earn_path(entry), class: "text-blue-400 hover:text-blue-300" %>
                <%= link_to "Edit", edit_learn_and_earn_path(entry), class: "text-green-400 hover:text-green-300" %>
                <%= button_to "Delete", learn_and_earn_path(entry), 
                    method: :delete, 
                    form: { data: { turbo_confirm: "Are you sure you want to delete this entry? This action cannot be undone." } },
                    class: "text-red-500 hover:text-red-400 bg-transparent border-none p-0 cursor-pointer underline" %>
              <% else %>
                <%= link_to "Submit Proof", edit_learn_and_earn_path(entry), class: "text-green-400 hover:text-green-300" %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <% if @learn_and_earns.total_pages > 1 %>
    <div class="mt-8 flex justify-center">
      <%= paginate @learn_and_earns %>
    </div>
    
    <div class="mt-4 text-center text-blue-300 text-sm">
      Page <%= @learn_and_earns.current_page %> of <%= @learn_and_earns.total_pages %> 
      (<%= @learn_and_earns.offset_value + 1 %> - <%= [@learn_and_earns.offset_value + @learn_and_earns.limit_value, @learn_and_earns.total_count].min %> of <%= @learn_and_earns.total_count %> entries)
    </div>
  <% end %>

  <!-- Enhanced Scripts -->
  <script>
    // Initialize bulk selection functionality
    function initializeBulkSelection() {
      // Wait for all elements to be available
      const bulkActionsBar = document.getElementById('bulk-actions-bar');
      const selectAllBtn = document.getElementById('select-all');
      const deselectAllBtn = document.getElementById('deselect-all');
      const selectAllHeader = document.getElementById('select-all-header');
      const checkboxes = document.querySelectorAll('.entry-checkbox');
      const bulkDeleteForm = document.getElementById('bulk-delete-form');
      const selectedIdsContainer = document.getElementById('selected-ids-container');
      const selectedCount = document.getElementById('selected-count');
      const deleteButton = document.getElementById('bulk-delete-button');

      // If essential elements are missing, retry or exit
      if (!bulkActionsBar || !bulkDeleteForm || !selectedIdsContainer) {
        console.warn('Bulk selection elements not found, retrying...');
        setTimeout(initializeBulkSelection, 100);
        return;
      }

      if (checkboxes.length === 0) {
        console.log('No checkboxes found');
        return;
      }
      // Copy Button Functionality
      document.body.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-copy-target]');
        if (!button) return;

        const targetId = button.getAttribute('data-copy-target');
        const textToCopy = document.getElementById(targetId)?.textContent || '';
        if (!textToCopy) return;

        navigator.clipboard.writeText(textToCopy).then(() => {
          const originalText = button.textContent;
          button.textContent = "Copied!";
          setTimeout(() => button.textContent = originalText, 2000);
        }).catch(() => {
          alert("Failed to copy to clipboard");
        });
      });

      // Update selected count and bulk actions bar visibility
      function updateSelectionState() {
        const checkedBoxes = document.querySelectorAll('.entry-checkbox:checked');
        const count = checkedBoxes.length;
        
        if (selectedCount) {
          selectedCount.textContent = count;
        }
        
        if (bulkActionsBar) {
          if (count > 0) {
            bulkActionsBar.classList.remove('hidden');
            bulkActionsBar.classList.add('block');
          } else {
            bulkActionsBar.classList.add('hidden');
            bulkActionsBar.classList.remove('block');
          }
        }
        
        // Enable/disable delete button
        if (deleteButton) {
          deleteButton.disabled = count === 0;
        }
        
        // Update header checkbox state
        if (selectAllHeader) {
          if (count === 0) {
            selectAllHeader.checked = false;
            selectAllHeader.indeterminate = false;
          } else if (count === checkboxes.length) {
            selectAllHeader.checked = true;
            selectAllHeader.indeterminate = false;
          } else {
            selectAllHeader.checked = false;
            selectAllHeader.indeterminate = true;
          }
        }
      }

      // Prepare form data for submission
      function prepareFormData() {
        const checkedBoxes = document.querySelectorAll('.entry-checkbox:checked');
        const ids = Array.from(checkedBoxes).map(checkbox => parseInt(checkbox.value));
        
        // Clear previous inputs
        selectedIdsContainer.innerHTML = '';
        
        // Add hidden inputs for each selected ID
        ids.forEach(id => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'ids[]';
          input.value = id;
          selectedIdsContainer.appendChild(input);
        });
        
        return ids.length > 0;
      }

      // Event listeners for checkboxes
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          updateSelectionState();
          // Add visual feedback
          const row = this.closest('tr');
          if (row) {
            if (this.checked) {
              row.classList.add('bg-blue-900/20', 'border-l-4', 'border-blue-500');
            } else {
              row.classList.remove('bg-blue-900/20', 'border-l-4', 'border-blue-500');
            }
          }
        });
      });

      // Select All button
      if (selectAllBtn) {
        selectAllBtn.addEventListener('click', () => {
          checkboxes.forEach(checkbox => {
            checkbox.checked = true;
            // Add visual feedback
            const row = checkbox.closest('tr');
            if (row) {
              row.classList.add('bg-blue-900/20', 'border-l-4', 'border-blue-500');
            }
          });
          updateSelectionState();
        });
      }

      // Deselect All button
      if (deselectAllBtn) {
        deselectAllBtn.addEventListener('click', () => {
          checkboxes.forEach(checkbox => {
            checkbox.checked = false;
            // Remove visual feedback
            const row = checkbox.closest('tr');
            if (row) {
              row.classList.remove('bg-blue-900/20', 'border-l-4', 'border-blue-500');
            }
          });
          updateSelectionState();
        });
      }

      // Bulk Delete button
      if (deleteButton) {
        deleteButton.addEventListener('click', function() {
          if (prepareFormData()) {
            // Show confirmation dialog
            if (confirm('Are you sure you want to permanently delete the selected entries? This action cannot be undone.')) {
              // Disable button and show loading state
              this.disabled = true;
              this.textContent = 'Deleting...';
              
              // Submit the form
              bulkDeleteForm.submit();
            }
          } else {
            alert('Please select at least one entry to delete.');
          }
        });
      }

      // Header checkbox
      if (selectAllHeader) {
        selectAllHeader.addEventListener('change', function(e) {
          const isChecked = e.target.checked;
          checkboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
            // Add/remove visual feedback
            const row = checkbox.closest('tr');
            if (row) {
              if (isChecked) {
                row.classList.add('bg-blue-900/20', 'border-l-4', 'border-blue-500');
              } else {
                row.classList.remove('bg-blue-900/20', 'border-l-4', 'border-blue-500');
              }
            }
          });
          updateSelectionState();
        });
      }

      // Initialize selection state
      updateSelectionState();

      // Handle pagination/ajax updates
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'childList') {
            // Re-initialize if new checkboxes are added
            const newCheckboxes = document.querySelectorAll('.entry-checkbox');
            if (newCheckboxes.length !== checkboxes.length) {
              setTimeout(initializeBulkSelection, 100);
            }
          }
        });
      });

      // Observe changes to the table
      const table = document.querySelector('table');
      if (table) {
        observer.observe(table, { childList: true, subtree: true });
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeBulkSelection);
    } else {
      initializeBulkSelection();
    }
  </script>
</body>
