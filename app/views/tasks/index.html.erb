<body class="bg-black text-blue-100">
  <h1 class="text-3xl font-bold text-blue-400 mb-6 text-center">ðŸ“‹ Tasks</h1>

  <% if current_user.admin? %>
    <div class="text-center mb-6">
      <%= link_to "âž• New Task", new_task_path,
                  class: "inline-block px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition" %>
    </div>
  <% end %>

  <table class="w-full border border-blue-800 text-blue-100 bg-black rounded-xl shadow-lg">
    <thead class="bg-blue-950 text-blue-400">
      <tr>
        <th class="px-4 py-3 border-b border-blue-800 text-left">Name</th>
        <th class="px-4 py-3 border-b border-blue-800 text-left">Type</th>
        <th class="px-4 py-3 border-b border-blue-800 text-left">Link</th>
        <th class="px-4 py-3 border-b border-blue-800 text-left">Description</th>
        <% if current_user.admin? %>
          <th class="px-4 py-3 border-b border-blue-800 text-left">Actions</th>
        <% end %>
      </tr>
    </thead>

    <tbody>
      <% @tasks.each do |task| %>
        <tr class="hover:bg-blue-950 transition">
          <td class="px-4 py-3 border-b border-blue-900"><%= task.name %></td>
          <td class="px-4 py-3 border-b border-blue-900"><%= task.task_type %></td>
          <td class="px-4 py-3 border-b border-blue-900">
            <div class="flex items-center justify-between gap-2">
              <span class="truncate max-w-xs"><%= task.link %></span>
              <button
                type="button"
                class="shrink-0 px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-semibold focus:outline-none focus:ring-2 focus:ring-blue-400 transition copy-btn"
                data-copy-text="<%= task.link %>"
                data-notification="Task link copied to clipboard!">
                Copy
              </button>
            </div>
          </td>
          <td class="px-4 py-3 border-b border-blue-900"><%= task.description %></td>

          <% if current_user.admin? %>
            <td class="px-4 py-3 border-b border-blue-900 space-x-3">
              <%= link_to "âœï¸ Edit", edit_task_path(task), class: "text-blue-400 hover:text-blue-300" %> |
              <%= link_to "ðŸ—‘ï¸ Delete", task_path(task),
                          data: { turbo_method: :delete, turbo_confirm: "Are you sure?" },
                          class: "text-red-400 hover:text-red-300" %> |
              <a href="#" 
                 onclick="sendToAll(event, <%= task.id %>, '<%= send_to_all_task_path(task) %>', '<%= form_authenticity_token %>')" 
                 class="text-yellow-400 hover:text-yellow-300">ðŸ“¢ Send to All</a>
            </td>
          <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>

  <div class="mt-6 flex justify-center">
    <%= paginate @tasks %>
  </div>

  <script>
    // 1. Defined outside the loop so they are only initialized once
    function sendToAll(event, taskId, url, authToken) {
      event.preventDefault();
      if (confirm("Send this task to all users?")) {
        fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': authToken
          },
          body: JSON.stringify({})
        }).then(response => {
          if (response.ok) {
            window.location.reload();
          } else {
            alert("Failed to send task to all users");
          }
        });
      }
    }

    function copyToClipboard(text) {
      if (!text) return;
      // Modern API
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).catch(err => {
          console.error('Clipboard API failed, falling back', err);
          fallbackCopy(text);
        });
      } else {
        fallbackCopy(text);
      }
    }

    function fallbackCopy(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.position = "fixed"; // avoid scrolling to bottom
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        document.execCommand('copy');
      } catch (err) {
        console.error('Fallback copy failed', err);
      }
      document.body.removeChild(textArea);
    }

    function showNotification(message) {
      const existing = document.querySelector('.toast-notification');
      if (existing) existing.remove();

      const notification = document.createElement('div');
      notification.className = 'toast-notification fixed top-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-pulse';
      notification.textContent = message;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s ease';
        setTimeout(() => notification.remove(), 500);
      }, 3000);
    }

    // 2. Use 'turbo:load' to support Rails navigation
    // Use 'DOMContentLoaded' as a fallback for non-turbo environments
    const initCopyButtons = () => {
      // Remove old listener if it exists to prevent duplicates
      document.body.removeEventListener('click', handleCopyClick);
      document.body.addEventListener('click', handleCopyClick);
    };

    function handleCopyClick(e) {
      const btn = e.target.closest('.copy-btn');
      if (btn) {
        e.preventDefault();
        const copyText = btn.getAttribute('data-copy-text');
        const notificationText = btn.getAttribute('data-notification');
        
        if (copyText) {
          copyToClipboard(copyText);
          showNotification(notificationText);
        }
      }
    }

    document.addEventListener('DOMContentLoaded', initCopyButtons);
    document.addEventListener('turbo:load', initCopyButtons);
  </script>
</body>